CREATE TABLE IF NOT EXISTS users(
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
);

CREATE TABLE IF NOT EXISTS sqrl(
  idk CHAR(44) PRIMARY KEY,
  suk CHAR(44),
  vuk CHAR(44),
  hardlock BOOLEAN DEFAULT FALSE,
  sqrlonly BOOLEAN DEFAULT FALSE,
  created TIMESTAMP DEFAULT NOW(),
  disabled TIMESTAMP,
  superseded TIMESTAMP,
  user_id INT NOT NULL REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS nuts(
  nut CHAR(44) PRIMARY KEY,
  code CHAR(44) NOT NULL,
  ip VARCHAR(50) NOT NULL,
  hmac CHAR(45),
  created TIMESTAMP DEFAULT NOW(),
  used TIMESTAMP,
  identified TIMESTAMP,
  issued TIMESTAMP,
  user_id INT REFERENCES users(id)
);

ALTER TABLE sqrl
  ADD created TIMESTAMP DEFAULT NOW(),
  ADD disabled TIMESTAMP;

UPDATE sqrl SET created=NOW() WHERE created IS NULL;
UPDATE sqrl SET disabled=NOW() WHERE enabled=FALSE;

ALTER TABLE sqrl DROP enabled;
