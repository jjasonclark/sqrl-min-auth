#!/usr/bin/env node
'use strict';

const path = require('path');
const fs = require('fs');
const util = require('util');
const logger = require('pino')({ level: 'info' });
const readFile = util.promisify(fs.readFile);
const pgp = require('pg-promise')();
// const { applySqlFile } = require('../src/lib/db');

const sqlPath = path.resolve(__dirname, '..', 'sql', 'create.sql');
const db = pgp('postgres://sqrl:sqrl@localhost:5432/sqrl');

const applySqlFile = async (dbo, sqlPath) => {
  try {
    logger.info({ sqlPath }, 'reading file');
    const commands = (await readFile(sqlPath)).toString();
    logger.info({ commandLength: commands.length }, 'Read migration file');
    const result = await dbo.none(commands);
    logger.info({ result }, 'Apply success');
    return true;
  } catch (error) {
    logger.error(error);
  }
  return false;
};

applySqlFile(db, sqlPath);
