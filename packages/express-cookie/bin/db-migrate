#!/usr/bin/env node
'use strict';

const path = require('path');
const fs = require('fs');
const util = require('util');
const logger = require('pino')({ level: 'info' });
const readFile = util.promisify(fs.readFile);
const pgp = require('pg-promise')();

const sqlPath = path.resolve(__dirname, '..', 'sql', 'create.sql');
const connectionString = 'postgres://sqrl:sqrl@localhost:5432/sqrl';

const applySqlFile = async () => {
  try {
    logger.info({ sqlPath }, 'reading file');
    const commands = (await readFile(sqlPath)).toString();
    logger.info({ commandLength: commands.length }, 'Read migration file');
    const db = pgp(connectionString);
    const result = await db.none(commands);
    logger.info({ result }, 'Apply success');
    await pgp.end();
    return true;
  } catch (error) {
    logger.error(error);
  }
  return false;
};

applySqlFile();
